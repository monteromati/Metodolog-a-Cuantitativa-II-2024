---
title: "Taller 3b"
format: html
editor: 
  markdown: 
    wrap: 72
---

![](logo-ie-ciae.gif){fig-align="left" width="200"}

# An谩lisis de Regresi贸n Log铆stica 

En esta sesi贸n, aprender谩s a realizar un an谩lisis de regresi贸n log铆stica utilizando datos de matr铆cula de educaci贸n superior de los a帽os 2021 y 2022. La regresi贸n log铆stica es una t茅cnica estad铆stica utilizada para modelar la probabilidad de ocurrencia de un evento binario, como la deserci贸n de estudiantes, en funci贸n de una o m谩s variables independientes. Exploraremos c贸mo preparar los datos, ajustar el modelo, evaluar los supuestos, interpretar los resultados y visualizar las relaciones entre las variables.

Comencemos estableciendo el directorio de trabajo.

```{r}
getwd() # Verifica el directorio de trabajo actual
setwd("G:/Mi unidad/Teaching/Metodolog铆a Cuantitativa II 2024/Sesi贸n 3") # Cambia esta l铆nea de c贸digo por tu directorio de trabajo
```

## Instalar y Cargar Paquetes

Instalemos y carguemos los paquetes que utilizaremos en esta sesi贸n usando el paquete `pacman`.

```{r}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, # tidyverse es en realidad una colecci贸n de paquetes muy popular, que incluye ggplot2, dplyr, etc
               corrplot,
               GGally,
               lmtest,
               DescTools,
               car,
               reshape2,
               tidymodels,
               knitr)
```

## Importar Datos

Importamos los datos de matr铆cula de educaci贸n superior para los a帽os 2021 y 2022. Luego, seleccionamos la cohorte de estudiantes que ingresaron en 2021 para estudiar la deserci贸n en su primer a帽o.

```{r}
# Importar los datos de matr铆cula para 2021 y 2022
mat2021 <- read.csv(file = "20230802_Matr铆cula_Ed_Superior_2021_PUBL_MRUN.csv", header = TRUE, sep = ";") 
mat2022 <- read.csv(file = "20230802_Matr铆cula_Ed_Superior_2022_PUBL_MRUN.csv", header = TRUE, sep = ";")
```

## Selecci贸n y manipulaci贸n

Parte importante del an谩lisis de datos es la creaci贸n, transformaci贸n, limpieza y recodificaci贸n de datos para los prop贸sitos que se busca. Aprendamos un poco acerca de aquellos con este trozo de c贸digo donde seleccionamos casos seg煤n cohorte y crearemos una nueva variable dependiente dicot贸mica que nos se帽alar谩 deserci贸n universitaria en base a estos dos conjuntos de datos de `mat2021` y `mat2022`.

```{r}
# Selecci贸n de casos: Cohorte que ingres贸 en 2021
mat2021_1anio <- mat2021[which(mat2021$anio_ing_carr_ori == "2021"),]
mat2022_2anio <- mat2022[which(mat2022$anio_ing_carr_ori == "2021"),]

# Generaci贸n de variable dependiente: Indicador de Deserci贸n
mat2021_1anio$deserta <- ifelse(mat2021_1anio$mrun %in% mat2022_2anio$mrun, "0", "1")
mat2021_1anio$deserta <- as.numeric(mat2021_1anio$deserta)

# Seleccionamos solo a estudiantes de pregrado
mat2021_1anio <- mat2021_1anio[which(mat2021_1anio$nivel_global == "Pregrado"),]

# Exploraci贸n de los datos
head(mat2021_1anio)
dim(mat2021_1anio)
str(mat2021_1anio)

# Recodificaci贸n de la variable g茅nero
mat2021_1anio$female <- as.numeric(mat2021_1anio$gen_alu)
mat2021_1anio$female[mat2021_1anio$female == "1"] <- 0
mat2021_1anio$female[mat2021_1anio$female == "2"] <- 1

# C谩lculo de la edad al ingreso en la educaci贸n superior
mat2021_1anio$anio_nac <- as.numeric(str_sub(mat2021_1anio$fec_nac_alu, 1, 4)) 
mat2021_1anio$anio_ing_carr_ori <- as.numeric(mat2021_1anio$anio_ing_carr_ori)
mat2021_1anio$edad_alu <- mat2021_1anio$anio_ing_carr_ori - mat2021_1anio$anio_nac

# Filtramos datos err贸neos de edad
summary(mat2021_1anio$edad_alu)
mat2021_1anio <- mat2021_1anio[!(mat2021_1anio$edad_alu == 121),]
summary(mat2021_1anio$edad_alu)

# Filtrar para eliminar NA's presentes en predictores para conformar la muestra anal铆tica de inter茅s
mat2021_1anio <- filter(mat2021_1anio, !is.na(female) & !is.na(edad_alu) & !is.na(dur_total_carr) & !is.na(valor_arancel))

# Removamos los data frames que no utilizaremos para liberar espacio de memoria RAM
rm(mat2021, mat2022, mat2022_2anio)
```

## Visualizaci贸n de la Variable Dependiente
Visualizamos la distribuci贸n de la variable dependiente `deserta` utilizando un gr谩fico de barras.

```{r}
ggplot(data = mat2021_1anio, aes(deserta, fill = deserta)) +
  geom_bar(position = "dodge") +
  ggtitle("Deserci贸n") +
  ylab("Cantidad") + 
  scale_fill_manual(values = c("#87ceeb", "#ffd700")) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = 'top')
```

## An谩lisis de Regresi贸n Log铆stica
Ajustamos un modelo de regresi贸n log铆stica para predecir la deserci贸n (`deserta`) en funci贸n de las variables `female` (g茅nero) y `edad_alu` (edad al ingreso).

```{r}
m2 <- glm(deserta ~ female + edad_alu, family = binomial(logit), data = mat2021_1anio)
summary(m2)
```

### Evaluaci贸n de los Supuestos de la Regresi贸n Log铆stica
Es importante verificar que los supuestos de la regresi贸n log铆stica se cumplen para garantizar la validez de las estimaciones del modelo.

-    **Variable dependiente categ贸rica**: La variable que estamos tratando de predecir (deserta) es binaria, lo que cumple con el primer supuesto.
-    **Independencia de las observaciones**: Este supuesto no se eval煤a estad铆sticamente, pero es importante asegurarse de que cada observaci贸n (estudiante) es independiente de las dem谩s.
-    **Supuesto de Linealidad**: implica que la relaci贸n entre el logit de la variable dependiente y cada variable independiente es lineal. Verificamos este supuesto usando el Test Box-Tidwell. Si el resultado del test es no significativo, no se rechaza la hip贸tesis nula de linealidad, lo que indica que el supuesto de linealidad se cumple.

```{r}
logodds <- m2$linear.predictors
boxTidwell(logodds ~ mat2021_1anio$edad_alu)
```

-    **Supuesto de Ausencia de Multicolinealidad**: La multicolinealidad ocurre cuando las variables independientes est谩n altamente correlacionadas entre s铆. Evaluamos este supuesto utilizando la matriz de correlaci贸n y el Factor de Inflaci贸n de la Varianza (VIF). Si los valores de VIF son menores a 5, se considera que no hay un problema significativo de multicolinealidad. Si las correlacione son mayores a r > .08, entonces tambi茅n es un indicador de multicolinealidad.

```{r}
# Ajustamos un modelo con m谩s variables independientes
mat2021_1anio$valor_arancel <- as.numeric(mat2021_1anio$valor_arancel)
m3 <- glm(deserta ~ female + edad_alu + dur_total_carr + valor_arancel, family = binomial(logit), data = mat2021_1anio)
summary(m3)

# Correlaci贸n entre variables independientes continuas
cormat <- round(cor(mat2021_1anio[, c("edad_alu", "dur_total_carr", "valor_arancel")]), 2)
melted_cormat <- melt(cormat)

# Visualizaci贸n de la matriz de correlaci贸n
ggplot(data = melted_cormat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile()

# Calcular VIF
kable(vif(m3), digits = 2)
```

Los resultados de estos an谩lisis sugieren que se cumple el supuesto de ausencia de multicolinealidad entre las variables independientes del modelo.

### Resultados de la Regresi贸n Log铆stica
Interpretamos los resultados del modelo ajustado `m3`, evaluando la significancia de los coeficientes, direccionalidad y tama帽o de los coeficientes (Estimates en el output) y calculando las probabilidades estimadas. Tambi茅n, en regresi贸n log铆stica es posible obtener el pseudo R2 que nos muestra la proporci贸n de la varianza explicada de nuestra variable dependiente por el modelo.

```{r}
summary(m3)
PseudoR2(m3)
```

Los coeficientes de regresi贸n log铆stica son el logaritmo natural de los odds (log-odds) de que ocurra el evento de la variable dependiente, que en este caso es desertar o no. La forma m谩s intuitiva de interpretarlos es elevar al cuadrado los exponentes para obtenerlos en razones de odds (odd-ratio), los cuales pueden ser interpretados como la probabilidad de que un evento ocurra respecto a que no ocurra. Calculemos aquello en el siguiente c贸digo.

```{r}
m3$coefficients # coeficientes en log-odds
exp(m3$coefficients) # coeficientes en odd ratios
exp(confint(m3))
```

**Interpretaci贸n**: se puede se帽alar que, por cada unidad que aumenta la edad del estudiante `edad_alu`, entonces la probabilidad de desertar en primer a帽o es del 3%.

### Comparaci贸n respecto al modelo nulo
Al estimar un chi-cuadrado del modelo (`m3`), podemos evaluar si es significativamente mejor que el modelo nulo o vac铆o (i.e. que contiene solo el intercepto y ning煤n predictor).

```{r}
# C谩lculo de la chi-cuadrado del modelo
modelChi <- m3$null.deviance - m3$deviance
chidf <- m3$df.null - m3$df.residual
chisq.prob <- 1 - pchisq(modelChi, chidf)
chisq.prob  # Significancia del modelo
```

Por ejemplo, en el siguiente c贸digo podemos obtener la probabilidad de que una mujer de 19 a帽os, en un programa de 5 semestres de duraci贸n y con un arancel de $2.510.000 deserte es de 27%

```{r}
# Probabilidades estimadas
mat2021_1anio$Probabilidades_estimadas <- m3$fitted.values

# Mostrar algunas probabilidades estimadas
kable(mat2021_1anio[c(1:10), c("deserta", "female", "edad_alu", "dur_total_carr", "valor_arancel", "Probabilidades_estimadas")], digits = 2)
```

La bondad de clasificaci贸n es un an谩lisis para evaluar la capacidad predictiva del modelo a nivel de los estudiantes, indic谩ndonos la proporci贸n de estudiantes que han sido clasificados correctamente por el modelo. Como vemos en el siguiente c贸digo, la precisi贸n de la predicci贸n es del 73%, lo que indica que nuestro modelo logra una mejora razonable de las predicciones.

```{r}
probabilities = m3 %>% predict(mat2021_1anio, type = "response")
head(probabilities)
predicted = ifelse(probabilities > 0.5, 1, 0)
mean(predicted == mat2021_1anio$deserta)
```

### Visualizaci贸n
Visualizamos los resultados del modelo de regresi贸n log铆stica ajustado, incluyendo la relaci贸n entre las variables independientes y la probabilidad de deserci贸n.

```{r}
m3_augmented <- augment(m3)

# Relaci贸n entre edad al ingreso y deserci贸n
ggplot(m3_augmented, aes(edad_alu, deserta)) +
  geom_point(lwd = 3, alpha = .5) +
  stat_smooth(method = "glm", se = TRUE, method.args = list(family = binomial), color = "royalblue") +
  theme_bw(base_size = 22) 

# Relaci贸n entre duraci贸n total de la carrera y deserci贸n
ggplot(m3_augmented, aes(dur_total_carr, deserta)) +
  geom_point(lwd = 3, alpha = .5) +
  stat_smooth(method = "glm", se = TRUE, method.args = list(family = binomial), color = "royalblue") +
  theme_bw(base_size = 22) 

# Relaci贸n entre valor del arancel y deserci贸n
ggplot(m3_augmented, aes(valor_arancel, deserta)) +
  geom_point(lwd = 3, alpha = .5) +
  stat_smooth(method = "glm", se = TRUE, method.args = list(family = binomial), color = "royalblue") +
  theme_bw(base_size = 22) 
```

### Comparaci贸n de Modelos
Finalmente, comparamos los modelos `m2` y `m3` para determinar cu谩l ajusta mejor a los datos. Los resultados indican que el modelo 3 ajusta significativamente mejor a los datos que el modelo 2.

```{r}
anova(m2, m3)
```